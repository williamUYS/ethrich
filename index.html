<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数字资产交易计算器 - 专业工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
        }

        body {
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: #fff;
            padding: 24px 32px;
            border-bottom: 2px solid #e8ecef;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        h1 {
            font-size: 1.75rem;
            margin-bottom: 8px;
            color: #1a365d;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .subtitle {
            color: #64748b;
            font-size: 0.95rem;
            margin-top: 6px;
        }

        .calculator-container {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e8ecef;
            overflow: hidden;
        }

        .mode-tabs {
            display: flex;
            border-bottom: 1px solid #e8ecef;
            background: #fafbfc;
        }

        .mode-tab {
            flex: 1;
            padding: 16px 24px;
            border: none;
            background: transparent;
            color: #64748b;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .mode-tab:hover {
            color: #4a5568;
            background: rgba(0,0,0,0.02);
        }

        .mode-tab.active {
            color: #3182ce;
            border-bottom-color: #3182ce;
            background: #fff;
            font-weight: 600;
        }

        .content-section {
            padding: 32px;
        }

        .input-section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 1.1rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e8ecef;
            color: #2d3748;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #4a5568;
            font-size: 0.9rem;
        }

        input, select {
            width: 100%;
            padding: 10px 14px;
            background: #fff;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            color: #2d3748;
            font-size: 1rem;
            transition: all 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        input::placeholder {
            color: #a0aec0;
        }

        .direction-group {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .direction-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 6px;
            background: #fff;
            color: #718096;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .direction-btn:hover {
            border-color: #a0aec0;
        }

        .direction-btn.active {
            border-color: #3182ce;
            background: #ebf8ff;
            color: #3182ce;
            font-weight: 600;
        }

        .direction-btn.buy.active {
            border-color: #48bb78;
            background: #f0fff4;
            color: #2f855a;
        }

        .direction-btn.sell.active {
            border-color: #f56565;
            background: #fff5f5;
            color: #c53030;
        }

        .calculate-btn {
            background: #3182ce;
            color: white;
            border: none;
            width: 100%;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.2s;
        }

        .calculate-btn:hover {
            background: #2c5282;
        }

        .calculate-btn:active {
            transform: translateY(1px);
        }

        .result-section {
            background: #f8fafc;
            border: 1px solid #e8ecef;
            border-radius: 6px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .result-display {
            text-align: center;
            padding: 20px;
        }

        .result-label {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2d3748;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }

        .result-subtext {
            color: #718096;
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .verification-section {
            background: #fff;
            border: 1px solid #e8ecef;
            border-radius: 6px;
            padding: 20px;
            margin-top: 16px;
        }

        .verification-title {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 12px;
            font-size: 0.95rem;
        }

        .verification-steps {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #4a5568;
        }

        .verification-steps .step {
            margin-bottom: 6px;
            padding-left: 16px;
            position: relative;
        }

        .verification-steps .step:before {
            content: "•";
            position: absolute;
            left: 0;
            color: #3182ce;
            font-weight: bold;
        }

        .risk-meter {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e8ecef;
        }

        .risk-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #4a5568;
            font-weight: 500;
        }

        .risk-bar {
            height: 8px;
            background: #e8ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .risk-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .risk-low { background: #48bb78; }
        .risk-medium { background: #ed8936; }
        .risk-high { background: #f56565; }

        .notes {
            background: #fffbeb;
            border: 1px solid #fbd38d;
            border-radius: 6px;
            padding: 16px;
            margin-top: 20px;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .notes h3 {
            margin-bottom: 10px;
            color: #975a16;
            font-size: 0.95rem;
        }

        .notes ul {
            padding-left: 20px;
            margin-top: 8px;
        }

        .notes li {
            margin-bottom: 4px;
            color: #744210;
        }

        footer {
            text-align: center;
            margin-top: 32px;
            color: #718096;
            font-size: 0.85rem;
            padding: 16px;
            border-top: 1px solid #e8ecef;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .content-section {
                padding: 20px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .result-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>数字资产交易计算器</h1>
            <div class="subtitle">专业交易工具 - 精确计算交易参数，严格控制风险</div>
        </header>

        <div class="calculator-container">
            <div class="mode-tabs">
                <button class="mode-tab active" data-mode="forward">方式一：计算开仓价格</button>
                <button class="mode-tab" data-mode="reverse">方式二：计算投入资金</button>
                <button class="mode-tab" data-mode="atr">方式三：ATR动态止损计算</button>
            </div>

            <!-- 方式一：计算开仓价格 -->
            <div class="content-section" id="modeForward">
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <!-- 左侧：输入参数 -->
                    <div style="flex: 1; min-width: 350px;">
                        <div class="input-section">
                            <h2 class="section-title">输入参数</h2>

                            <div class="input-group">
                                <label for="marginForward">投入资金 (USDT)</label>
                                <input type="number" id="marginForward" step="0.01" min="0.01" placeholder="请输入投入资金">
                            </div>

                            <div class="input-group">
                                <label for="maxLossForward">最大可接受亏损 (USDT)</label>
                                <input type="number" id="maxLossForward" step="0.01" min="0.01" placeholder="请输入最大可接受亏损">
                            </div>

                            <div class="input-group">
                                <label for="stopPriceForward">止损价格 (USDT)</label>
                                <input type="number" id="stopPriceForward" step="0.01" min="0.01" placeholder="请输入止损价格">
                            </div>

                            <div class="input-group">
                                <label for="leverageForward">杠杆倍数</label>
                                <input type="number" id="leverageForward" value="20" min="1" max="125">
                            </div>

                            <div class="input-group">
                                <label>交易方向</label>
                                <div class="direction-group">
                                    <div class="direction-btn sell active" data-direction="sell">
                                        <span>卖出</span>
                                    </div>
                                    <div class="direction-btn buy" data-direction="buy">
                                        <span>买入</span>
                                    </div>
                                </div>
                            </div>

                            <button class="calculate-btn" id="calculateBtnForward">计算开仓价格</button>

                            <div class="risk-meter">
                                <div class="risk-label">
                                    <span>风险水平</span>
                                    <span id="riskLevelForward">低风险</span>
                                </div>
                                <div class="risk-bar">
                                    <div class="risk-fill risk-low" id="riskFillForward" style="width: 20%"></div>
                                </div>
                                <div class="risk-label">
                                    <span>0%</span>
                                    <span>100%</span>
                                </div>
                            </div>

                            <div class="notes">
                                <h3>使用说明</h3>
                                <ul>
                                    <li>输入您的交易参数，点击"计算开仓价格"</li>
                                    <li>买入时：止损价格应低于开仓价格</li>
                                    <li>卖出时：止损价格应高于开仓价格</li>
                                    <li>风险水平基于亏损占投入资金比例计算</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧：结果展示 -->
                    <div style="flex: 1; min-width: 350px;">
                        <div class="result-section">
                            <h2 class="section-title">计算结果</h2>

                            <div class="result-display">
                                <div class="result-label">建议开仓价格</div>
                                <div class="result-value" id="entryPriceForward">-</div>
                                <div class="result-subtext" id="directionTextForward">-</div>
                            </div>

                            <div class="verification-section">
                                <div class="verification-title">验证计算</div>
                                <div class="verification-steps" id="verificationStepsForward">
                                    <div class="step">请输入参数并计算</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 方式二：计算投入资金 -->
            <div class="content-section hidden" id="modeReverse">
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <!-- 左侧：输入参数 -->
                    <div style="flex: 1; min-width: 350px;">
                        <div class="input-section">
                            <h2 class="section-title">输入参数</h2>

                            <div class="input-group">
                                <label for="maxLossReverse">最大可接受亏损 (USDT)</label>
                                <input type="number" id="maxLossReverse" step="0.01" min="0.01" placeholder="请输入最大可接受亏损">
                            </div>

                            <div class="input-group">
                                <label for="stopPriceReverse">止损价格 (USDT)</label>
                                <input type="number" id="stopPriceReverse" step="0.01" min="0.01" placeholder="请输入止损价格">
                            </div>

                            <div class="input-group">
                                <label for="leverageReverse">杠杆倍数</label>
                                <input type="number" id="leverageReverse" value="20" min="1" max="125">
                            </div>

                            <div class="input-group">
                                <label for="entryPriceReverse">开仓价格 (USDT)</label>
                                <input type="number" id="entryPriceReverse" step="0.01" min="0.01" placeholder="请输入开仓价格">
                            </div>

                            <div class="input-group">
                                <label>交易方向</label>
                                <div class="direction-group">
                                    <div class="direction-btn sell active" data-direction="sell">
                                        <span>卖出</span>
                                    </div>
                                    <div class="direction-btn buy" data-direction="buy">
                                        <span>买入</span>
                                    </div>
                                </div>
                            </div>

                            <button class="calculate-btn" id="calculateBtnReverse">计算投入资金</button>

                            <div class="notes">
                                <h3>使用说明</h3>
                                <ul>
                                    <li>输入您的交易参数，点击"计算投入资金"</li>
                                    <li>买入时：止损价格应低于开仓价格</li>
                                    <li>卖出时：止损价格应高于开仓价格</li>
                                    <li>根据给定的风险和价格参数，反推需要的投入资金</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧：结果展示 -->
                    <div style="flex: 1; min-width: 350px;">
                        <div class="result-section">
                            <h2 class="section-title">计算结果</h2>

                            <div class="result-display">
                                <div class="result-label">建议投入资金</div>
                                <div class="result-value" id="marginReverse">-</div>
                                <div class="result-subtext" id="directionTextReverse">-</div>
                            </div>

                            <div class="verification-section">
                                <div class="verification-title">验证计算</div>
                                <div class="verification-steps" id="verificationStepsReverse">
                                    <div class="step">请输入参数并计算</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 方式三：ATR动态止损计算 -->
            <div class="content-section hidden" id="modeAtr">
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <!-- 左侧：输入参数 -->
                    <div style="flex: 1; min-width: 350px;">
                        <div class="input-section">
                            <h2 class="section-title">输入参数</h2>

                            <div class="input-group">
                                <label>交易方向</label>
                                <div class="direction-group">
                                    <div class="direction-btn sell active" data-direction="sell" id="atrDirectionBuy">
                                        <span>卖出</span>
                                    </div>
                                    <div class="direction-btn buy" data-direction="buy" id="atrDirectionSell">
                                        <span>买入</span>
                                    </div>
                                </div>
                            </div>

                            <div class="input-group">
                                <label for="atrMargin">投入资金 (USDT)</label>
                                <input type="number" id="atrMargin" step="0.01" min="0.01" placeholder="请输入投入资金">
                            </div>

                            <div class="input-group">
                                <label for="atrMaxLoss">最大可接受亏损 (USDT)</label>
                                <input type="number" id="atrMaxLoss" step="0.01" min="0.01" placeholder="请输入最大可接受亏损">
                            </div>

                            <div class="input-group">
                                <label for="atrValue">ATR值 (平均真实波幅)</label>
                                <input type="number" id="atrValue" step="0.01" min="0.01" placeholder="请输入ATR值">
                                <small style="color: #718096; font-size: 0.85rem;">需从其他工具或平台获取ATR值</small>
                            </div>

                            <div class="input-group">
                                <label for="atrMultiplier">ATR倍数</label>
                                <input type="number" id="atrMultiplier" value="1.5" step="0.1" min="0.1" max="10">
                                <small style="color: #718096; font-size: 0.85rem;">常用值：1.5-2.0</small>
                            </div>

                            <div class="input-group">
                                <label for="atrEntryPrice">开仓价格 (USDT)</label>
                                <input type="number" id="atrEntryPrice" step="0.01" min="0.01" placeholder="请输入开仓价格">
                            </div>

                            <div class="input-group">
                                <label for="atrLeverage">杠杆倍数</label>
                                <input type="number" id="atrLeverage" value="20" min="1" max="125">
                            </div>

                            <button class="calculate-btn" id="calculateBtnAtr">计算止损位置</button>

                            <div class="notes" style="margin-top: 16px;">
                                <h3>使用说明</h3>
                                <ul style="list-style-type: disc; padding-left: 20px; color: #744210;">
                                    <li>输入投入资金、最大亏损等参数</li>
                                    <li>ATR值越高，市场波动越大，止损距离应设置得更宽</li>
                                    <li>计算结果会显示两种止损位置供参考</li>
                                    <li>建议选择更保守的止损位置</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧：结果展示 -->
                    <div style="flex: 1; min-width: 350px;">
                        <!-- 止损结果 -->
                        <div class="result-section" style="margin-bottom: 20px;">
                            <h2 class="section-title">计算结果</h2>

                            <!-- 基于最大亏损的止损 -->
                            <div style="background: #f0fff4; border: 1px solid #c6f6d5; border-radius: 6px; padding: 20px; margin-bottom: 16px;">
                                <div style="font-size: 0.85rem; color: #2f855a; margin-bottom: 8px; font-weight: 600;">
                                    基于最大亏损的止损位置
                                </div>
                                <div style="font-size: 2.2rem; font-weight: 700; color: #276749;" id="atrStopLossByLoss">
                                    -
                                </div>
                                <div style="font-size: 0.9rem; color: #2f855a; margin-top: 4px;" id="atrStopLossByLossText">
                                    -
                                </div>
                            </div>

                            <!-- 基于ATR的止损 -->
                            <div style="background: #fffaf0; border: 1px solid #fbd38d; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
                                <div style="font-size: 0.85rem; color: #975a16; margin-bottom: 8px; font-weight: 600;">
                                    基于ATR的止损位置
                                </div>
                                <div style="font-size: 2.2rem; font-weight: 700; color: #975a16;" id="atrStopLossByATR">
                                    -
                                </div>
                                <div style="font-size: 0.9rem; color: #975a16; margin-top: 4px;" id="atrStopLossByATRText">
                                    -
                                </div>
                                <div style="font-size: 0.9rem; color: #975a16; margin-top: 8px;" id="atrStopLossByATRLoss">
                                    -
                                </div>
                            </div>

                            <!-- 详细信息 -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px;">
                                <div style="background: #f7fafc; padding: 12px; border-radius: 6px;">
                                    <div style="font-size: 0.8rem; color: #718096; margin-bottom: 4px;">ATR止损距离</div>
                                    <div style="font-size: 1.1rem; font-weight: 600; color: #2d3748;" id="atrStopLossDistance">
                                        -
                                    </div>
                                </div>
                                <div style="background: #f7fafc; padding: 12px; border-radius: 6px;">
                                    <div style="font-size: 0.8rem; color: #718096; margin-bottom: 4px;">ATR止损比例</div>
                                    <div style="font-size: 1.1rem; font-weight: 600; color: #2d3748;" id="atrStopLossRatio">
                                        -
                                    </div>
                                </div>
                                <div style="background: #f7fafc; padding: 12px; border-radius: 6px;">
                                    <div style="font-size: 0.8rem; color: #718096; margin-bottom: 4px;">仓位价值</div>
                                    <div style="font-size: 1.1rem; font-weight: 600; color: #2d3748;" id="atrPositionValue">
                                        -
                                    </div>
                                </div>
                                <div style="background: #f7fafc; padding: 12px; border-radius: 6px;">
                                    <div style="font-size: 0.8rem; color: #718096; margin-bottom: 4px;">风险水平</div>
                                    <div style="font-size: 1.1rem; font-weight: 600; color: #2d3748;" id="atrRiskLevel">
                                        -
                                    </div>
                                </div>
                            </div>

                            <!-- 验证步骤 -->
                            <div class="verification-section" style="margin-top: 20px;">
                                <div class="verification-title">验证计算</div>
                                <div class="verification-steps" id="atrVerificationSteps">
                                    <div class="step">请输入参数并计算</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>数字资产交易计算器 v2.0 | 专业交易工具 | 数据仅在本地计算，不会上传任何服务器</p>
            <p style="margin-top: 8px; font-size: 0.85rem; color: #718096;">© 2024 Trading Tools. All rights reserved.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 模式切换
            const modeTabs = document.querySelectorAll('.mode-tab');
            const modeForward = document.getElementById('modeForward');
            const modeReverse = document.getElementById('modeReverse');
            const modeAtr = document.getElementById('modeAtr');

            modeTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    modeTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    const mode = this.dataset.mode;
                    if (mode === 'forward') {
                        modeForward.classList.remove('hidden');
                        modeReverse.classList.add('hidden');
                        modeAtr.classList.add('hidden');
                    } else if (mode === 'reverse') {
                        modeForward.classList.add('hidden');
                        modeReverse.classList.remove('hidden');
                        modeAtr.classList.add('hidden');
                    } else if (mode === 'atr') {
                        modeForward.classList.add('hidden');
                        modeReverse.classList.add('hidden');
                        modeAtr.classList.remove('hidden');
                    }
                });
            });

            // 方式一：计算开仓价格
            const marginForward = document.getElementById('marginForward');
            const maxLossForward = document.getElementById('maxLossForward');
            const stopPriceForward = document.getElementById('stopPriceForward');
            const leverageForward = document.getElementById('leverageForward');
            const calculateBtnForward = document.getElementById('calculateBtnForward');
            const entryPriceForward = document.getElementById('entryPriceForward');
            const directionTextForward = document.getElementById('directionTextForward');
            const verificationStepsForward = document.getElementById('verificationStepsForward');
            const riskFillForward = document.getElementById('riskFillForward');
            const riskLevelForward = document.getElementById('riskLevelForward');
            const directionBtnsForward = document.querySelectorAll('#modeForward .direction-btn');

            let tradeDirectionForward = 'sell';

            directionBtnsForward.forEach(btn => {
                btn.addEventListener('click', function() {
                    directionBtnsForward.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    tradeDirectionForward = this.dataset.direction;
                    calculateEntryPrice();
                });
            });

            calculateBtnForward.addEventListener('click', calculateEntryPrice);

            [marginForward, maxLossForward, stopPriceForward, leverageForward].forEach(input => {
                input.addEventListener('change', calculateEntryPrice);
                input.addEventListener('keyup', function(e) {
                    if (e.key === 'Enter') calculateEntryPrice();
                });
            });

            // 方式二：计算投入资金
            const maxLossReverse = document.getElementById('maxLossReverse');
            const stopPriceReverse = document.getElementById('stopPriceReverse');
            const leverageReverse = document.getElementById('leverageReverse');
            const entryPriceReverse = document.getElementById('entryPriceReverse');
            const calculateBtnReverse = document.getElementById('calculateBtnReverse');
            const marginReverse = document.getElementById('marginReverse');
            const directionTextReverse = document.getElementById('directionTextReverse');
            const verificationStepsReverse = document.getElementById('verificationStepsReverse');
            const directionBtnsReverse = document.querySelectorAll('#modeReverse .direction-btn');

            let tradeDirectionReverse = 'sell';

            directionBtnsReverse.forEach(btn => {
                btn.addEventListener('click', function() {
                    directionBtnsReverse.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    tradeDirectionReverse = this.dataset.direction;
                    calculateMargin();
                });
            });

            calculateBtnReverse.addEventListener('click', calculateMargin);

            [maxLossReverse, stopPriceReverse, leverageReverse, entryPriceReverse].forEach(input => {
                input.addEventListener('change', calculateMargin);
                input.addEventListener('keyup', function(e) {
                    if (e.key === 'Enter') calculateMargin();
                });
            });

            // 初始时不计算，等待用户输入

            // 方式一：计算开仓价格
            function calculateEntryPrice() {
                const margin = parseFloat(marginForward.value);
                const maxLoss = parseFloat(maxLossForward.value);
                const stopPrice = parseFloat(stopPriceForward.value);
                const leverage = parseFloat(leverageForward.value);

                if (isNaN(margin) || isNaN(maxLoss) || isNaN(stopPrice) || isNaN(leverage) ||
                    margin <= 0 || maxLoss <= 0 || stopPrice <= 0 || leverage <= 0) {
                    showErrorForward("请输入有效的正数参数");
                    return;
                }

                if (maxLoss >= margin) {
                    showErrorForward("最大亏损不能大于或等于投入资金");
                    return;
                }

                const riskPercentage = (maxLoss / margin) * 100;
                updateRiskMeterForward(riskPercentage);

                let entryPrice;
                let verification = [];

                if (tradeDirectionForward === 'sell') {
                    // 卖出：开仓价 = 目标价 / (1 + (最大亏损 / (投入资金 * 杠杆)))
                    const denominator = 1 + (maxLoss / (margin * leverage));
                    entryPrice = stopPrice / denominator;

                    const priceChangePercent = ((stopPrice - entryPrice) / entryPrice) * 100;
                    const leveragedLossPercent = priceChangePercent * leverage;
                    const actualLoss = margin * (leveragedLossPercent / 100);

                    verification = [
                        `价格变动: (${stopPrice.toFixed(2)} - ${entryPrice.toFixed(2)}) / ${entryPrice.toFixed(2)} = ${priceChangePercent.toFixed(2)}%`,
                        `杠杆放大亏损: ${priceChangePercent.toFixed(2)}% × ${leverage} = ${leveragedLossPercent.toFixed(2)}%`,
                        `投入资金亏损: ${margin} × ${leveragedLossPercent.toFixed(2)}% = ${actualLoss.toFixed(2)} USDT`,
                        `实际亏损与设定最大亏损匹配 ✓`
                    ];

                    directionTextForward.textContent = "卖出方向 - 价格低于目标位";
                } else {
                    // 买入：开仓价 = 目标价 / (1 - (最大亏损 / (投入资金 * 杠杆)))
                    const ratio = maxLoss / (margin * leverage);
                    if (ratio >= 1) {
                        showErrorForward("参数错误：最大亏损不能超过投入资金与杠杆乘积");
                        return;
                    }

                    const denominator = 1 - ratio;
                    entryPrice = stopPrice / denominator;

                    const priceChangePercent = ((entryPrice - stopPrice) / entryPrice) * 100;
                    const leveragedLossPercent = priceChangePercent * leverage;
                    const actualLoss = margin * (leveragedLossPercent / 100);

                    verification = [
                        `价格变动: (${entryPrice.toFixed(2)} - ${stopPrice.toFixed(2)}) / ${entryPrice.toFixed(2)} = ${priceChangePercent.toFixed(2)}%`,
                        `杠杆放大亏损: ${priceChangePercent.toFixed(2)}% × ${leverage} = ${leveragedLossPercent.toFixed(2)}%`,
                        `投入资金亏损: ${margin} × ${leveragedLossPercent.toFixed(2)}% = ${actualLoss.toFixed(2)} USDT`,
                        `实际亏损与设定最大亏损匹配 ✓`
                    ];

                    directionTextForward.textContent = "买入方向 - 价格高于目标位";
                }

                entryPriceForward.textContent = entryPrice.toFixed(2);

                verificationStepsForward.innerHTML = '';
                verification.forEach(step => {
                    const div = document.createElement('div');
                    div.className = 'step';
                    div.textContent = step;
                    verificationStepsForward.appendChild(div);
                });
            }

            // 方式二：计算投入资金
            function calculateMargin() {
                const maxLoss = parseFloat(maxLossReverse.value);
                const stopPrice = parseFloat(stopPriceReverse.value);
                const leverage = parseFloat(leverageReverse.value);
                const entryPrice = parseFloat(entryPriceReverse.value);

                if (isNaN(maxLoss) || isNaN(stopPrice) || isNaN(leverage) || isNaN(entryPrice) ||
                    maxLoss <= 0 || stopPrice <= 0 || leverage <= 0 || entryPrice <= 0) {
                    showErrorReverse("请输入有效的正数参数");
                    return;
                }

                let margin;
                let verification = [];

                if (tradeDirectionReverse === 'sell') {
                    // 卖出：价格从开仓价上涨到目标价
                    // 投入资金 = 最大亏损 / ((目标价 - 开仓价) / 开仓价 * 杠杆)
                    const priceChangePercent = ((stopPrice - entryPrice) / entryPrice) * 100;
                    if (priceChangePercent <= 0) {
                        showErrorReverse("卖出时止损价格必须高于开仓价格");
                        return;
                    }

                    const leveragedLossPercent = priceChangePercent * leverage;
                    margin = maxLoss / (leveragedLossPercent / 100);

                    const actualLoss = margin * (leveragedLossPercent / 100);

                    verification = [
                        `价格变动: (${stopPrice.toFixed(2)} - ${entryPrice.toFixed(2)}) / ${entryPrice.toFixed(2)} = ${priceChangePercent.toFixed(2)}%`,
                        `杠杆放大亏损: ${priceChangePercent.toFixed(2)}% × ${leverage} = ${leveragedLossPercent.toFixed(2)}%`,
                        `投入资金亏损: ${margin.toFixed(2)} × ${leveragedLossPercent.toFixed(2)}% = ${actualLoss.toFixed(2)} USDT`,
                        `实际亏损与设定最大亏损匹配 ✓`
                    ];

                    directionTextReverse.textContent = "卖出方向 - 价格低于目标位";
                } else {
                    // 买入：价格从开仓价下跌到目标价
                    // 投入资金 = 最大亏损 / ((开仓价 - 目标价) / 开仓价 * 杠杆)
                    const priceChangePercent = ((entryPrice - stopPrice) / entryPrice) * 100;
                    if (priceChangePercent <= 0) {
                        showErrorReverse("买入时止损价格必须低于开仓价格");
                        return;
                    }

                    const leveragedLossPercent = priceChangePercent * leverage;
                    margin = maxLoss / (leveragedLossPercent / 100);

                    const actualLoss = margin * (leveragedLossPercent / 100);

                    verification = [
                        `价格变动: (${entryPrice.toFixed(2)} - ${stopPrice.toFixed(2)}) / ${entryPrice.toFixed(2)} = ${priceChangePercent.toFixed(2)}%`,
                        `杠杆放大亏损: ${priceChangePercent.toFixed(2)}% × ${leverage} = ${leveragedLossPercent.toFixed(2)}%`,
                        `投入资金亏损: ${margin.toFixed(2)} × ${leveragedLossPercent.toFixed(2)}% = ${actualLoss.toFixed(2)} USDT`,
                        `实际亏损与设定最大亏损匹配 ✓`
                    ];

                    directionTextReverse.textContent = "买入方向 - 价格高于目标位";
                }

                marginReverse.textContent = margin.toFixed(2);

                verificationStepsReverse.innerHTML = '';
                verification.forEach(step => {
                    const div = document.createElement('div');
                    div.className = 'step';
                    div.textContent = step;
                    verificationStepsReverse.appendChild(div);
                });
            }

            function updateRiskMeterForward(percentage) {
                percentage = Math.min(100, Math.max(0, percentage));
                riskFillForward.style.width = `${percentage}%`;

                if (percentage < 15) {
                    riskFillForward.className = 'risk-fill risk-low';
                    riskLevelForward.textContent = '低风险';
                } else if (percentage < 30) {
                    riskFillForward.className = 'risk-fill risk-medium';
                    riskLevelForward.textContent = '中风险';
                } else {
                    riskFillForward.className = 'risk-fill risk-high';
                    riskLevelForward.textContent = '高风险';
                }
            }

            function showErrorForward(message) {
                entryPriceForward.textContent = '错误';
                directionTextForward.textContent = message;
                verificationStepsForward.innerHTML = `<div class="step" style="color: #f56565;">${message}</div>`;
                riskFillForward.style.width = '100%';
                riskFillForward.className = 'risk-fill risk-high';
                riskLevelForward.textContent = '参数错误';
            }

            function showErrorReverse(message) {
                marginReverse.textContent = '错误';
                directionTextReverse.textContent = message;
                verificationStepsReverse.innerHTML = `<div class="step" style="color: #f56565;">${message}</div>`;
            }

            // ========== ATR模式 ==========
            // ATR交易方向
            const atrDirectionBuy = document.getElementById('atrDirectionBuy');
            const atrDirectionSell = document.getElementById('atrDirectionSell');
            let atrDirection = 'sell';

            [atrDirectionBuy, atrDirectionSell].forEach(btn => {
                btn.addEventListener('click', function() {
                    atrDirectionBuy.classList.remove('active');
                    atrDirectionSell.classList.remove('active');
                    this.classList.add('active');
                    atrDirection = this.dataset.direction;
                    calculateAtr();
                });
            });

            // ATR输入元素
            const atrMargin = document.getElementById('atrMargin');
            const atrMaxLoss = document.getElementById('atrMaxLoss');
            const atrValue = document.getElementById('atrValue');
            const atrMultiplier = document.getElementById('atrMultiplier');
            const atrEntryPrice = document.getElementById('atrEntryPrice');
            const atrLeverage = document.getElementById('atrLeverage');

            // ATR按钮
            const calculateBtnAtr = document.getElementById('calculateBtnAtr');

            // ATR输出元素
            const atrStopLossByLoss = document.getElementById('atrStopLossByLoss');
            const atrStopLossByLossText = document.getElementById('atrStopLossByLossText');
            const atrStopLossByATR = document.getElementById('atrStopLossByATR');
            const atrStopLossByATRText = document.getElementById('atrStopLossByATRText');
            const atrStopLossByATRLoss = document.getElementById('atrStopLossByATRLoss');
            const atrStopLossDistance = document.getElementById('atrStopLossDistance');
            const atrStopLossRatio = document.getElementById('atrStopLossRatio');
            const atrPositionValue = document.getElementById('atrPositionValue');
            const atrRiskLevel = document.getElementById('atrRiskLevel');
            const atrVerificationSteps = document.getElementById('atrVerificationSteps');

            // 绑定事件
            calculateBtnAtr.addEventListener('click', calculateAtr);

            // 输入变化时自动计算
            [atrMargin, atrMaxLoss, atrValue, atrMultiplier, atrEntryPrice, atrLeverage].forEach(input => {
                input.addEventListener('change', calculateAtr);
                input.addEventListener('keyup', function(e) {
                    if (e.key === 'Enter') calculateAtr();
                });
            });

            // 计算ATR止损位置
            function calculateAtr() {
                const margin = parseFloat(atrMargin.value);
                const maxLoss = parseFloat(atrMaxLoss.value);
                const atr = parseFloat(atrValue.value);
                const multiplier = parseFloat(atrMultiplier.value);
                const entryPrice = parseFloat(atrEntryPrice.value);
                const leverage = parseFloat(atrLeverage.value);

                if (isNaN(margin) || isNaN(maxLoss) || isNaN(atr) || isNaN(multiplier) ||
                    isNaN(entryPrice) || isNaN(leverage) ||
                    margin <= 0 || maxLoss <= 0 || atr <= 0 || multiplier <= 0 ||
                    entryPrice <= 0 || leverage <= 0) {
                    showAtrError("请输入有效的正数参数");
                    return;
                }

                if (maxLoss >= margin) {
                    showAtrError("最大亏损不能大于或等于投入资金");
                    return;
                }

                // 计算仓位价值
                const positionValue = margin * leverage;

                // 计算风险水平
                const riskLevelPercent = (maxLoss / margin) * 100;

                // 计算基于最大亏损的价格变动
                const priceChangeByLoss = (maxLoss / positionValue) * entryPrice;

                // 计算基于最大亏损的止损价格
                let stopLossByLoss;
                if (atrDirection === 'buy') {
                    stopLossByLoss = entryPrice - priceChangeByLoss;
                } else {
                    stopLossByLoss = entryPrice + priceChangeByLoss;
                }

                // 计算ATR止损距离
                const atrStopLossDistance = atr * multiplier;

                // 计算ATR止损比例
                const atrStopLossRatioPercent = (atrStopLossDistance / entryPrice) * 100;

                // 计算基于ATR的止损价格
                let stopLossByATR;
                if (atrDirection === 'buy') {
                    stopLossByATR = entryPrice - atrStopLossDistance;
                } else {
                    stopLossByATR = entryPrice + atrStopLossDistance;
                }

                // 计算基于ATR止损的亏损金额
                const atrLossAmount = (atrStopLossDistance / entryPrice) * positionValue;

                // 显示结果
                atrStopLossByLoss.textContent = stopLossByLoss.toFixed(2);
                atrStopLossByLossText.textContent = `亏损: ${maxLoss.toFixed(2)} USDT`;

                atrStopLossByATR.textContent = stopLossByATR.toFixed(2);
                atrStopLossByATRText.textContent = `止损距离: ${atrStopLossDistance.toFixed(2)} USDT`;
                atrStopLossByATRLoss.textContent = `亏损金额: ${atrLossAmount.toFixed(2)} USDT`;

                atrStopLossDistance.textContent = `${atrStopLossDistance.toFixed(2)} USDT`;
                atrStopLossRatio.textContent = `${atrStopLossRatioPercent.toFixed(2)}%`;
                atrPositionValue.textContent = `${positionValue.toFixed(2)} USDT`;
                atrRiskLevel.textContent = `${riskLevelPercent.toFixed(2)}%`;

                // 验证步骤
                const verification = [
                    `投入资金: ${margin} USDT`,
                    `杠杆倍数: ${leverage}`,
                    `仓位价值: ${margin} × ${leverage} = ${positionValue.toFixed(2)} USDT`,
                    `最大亏损: ${maxLoss} USDT`,
                    `ATR值: ${atr}, ATR倍数: ${multiplier}`,
                    atrDirection === 'buy'
                        ? `基于最大亏损止损: ${entryPrice.toFixed(2)} - ${priceChangeByLoss.toFixed(2)} = ${stopLossByLoss.toFixed(2)} USDT`
                        : `基于最大亏损止损: ${entryPrice.toFixed(2)} + ${priceChangeByLoss.toFixed(2)} = ${stopLossByLoss.toFixed(2)} USDT`,
                    atrDirection === 'buy'
                        ? `基于ATR止损: ${entryPrice.toFixed(2)} - ${atrStopLossDistance.toFixed(2)} = ${stopLossByATR.toFixed(2)} USDT`
                        : `基于ATR止损: ${entryPrice.toFixed(2)} + ${atrStopLossDistance.toFixed(2)} = ${stopLossByATR.toFixed(2)} USDT`,
                    `ATR止损亏损: (${atrStopLossDistance.toFixed(2)} / ${entryPrice.toFixed(2)}) × ${positionValue.toFixed(2)} = ${atrLossAmount.toFixed(2)} USDT`
                ];

                atrVerificationSteps.innerHTML = '';
                verification.forEach(step => {
                    const div = document.createElement('div');
                    div.className = 'step';
                    div.textContent = step;
                    atrVerificationSteps.appendChild(div);
                });
            }

            function showAtrError(message) {
                atrStopLossByLoss.textContent = '错误';
                atrStopLossByLossText.textContent = message;
                atrStopLossByATR.textContent = '-';
                atrStopLossByATRText.textContent = '-';
                atrStopLossByATRLoss.textContent = '-';
                atrStopLossDistance.textContent = '-';
                atrStopLossRatio.textContent = '-';
                atrPositionValue.textContent = '-';
                atrRiskLevel.textContent = '-';
                atrVerificationSteps.innerHTML = `<div class="step" style="color: #f56565;">${message}</div>`;
            }
        });
    </script>
</body>
</html>